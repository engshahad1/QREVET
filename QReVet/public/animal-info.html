<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; }
  </style>
</head>
<body class="bg-black text-white min-h-screen p-6">
  <div class="max-w-2xl mx-auto bg-zinc-900 rounded-2xl shadow-xl p-6 border border-orange-500">
    <h1 class="text-3xl font-bold text-orange-400 text-center mb-6">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</h1>

    <div id="animalImageContainer" class="flex justify-center mb-4"></div>
    <canvas id="qrcode" class="mx-auto mb-4"></canvas>

    <div id="animalDetails" class="space-y-3 text-base leading-loose px-4"></div>

    <div id="pdfBtnContainer" class="mt-8 text-center hidden">
      <button onclick="downloadPDF()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-full">
        ØªØ­Ù…ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© PDF
      </button>
    </div>
  </div>

  <!-- QR Code Generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const animalId = params.get("id");

    async function loadAnimal() {
      if (!animalId) return showError("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.");

      const res = await fetch('/api/animals');
      const data = await res.json();
      const animal = data.data.find(a => a.id == animalId);
      const container = document.getElementById("animalDetails");

      if (!animal) return showError("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠÙˆØ§Ù†.");

      let html = `
        <p><strong>ğŸ¾ Ø§Ø³Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</strong> ${animal.name}</p>
        <p><strong>ğŸ¬ Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</strong> ${animal.type}</p>
        <p><strong>ğŸ§‘â€ğŸŒ¾ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${animal.owner}</p>
        <p><strong>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ${animal.phone}</p>
        <p><strong>ğŸ†” Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${animal.ownerId}</p>
        <p><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> ${animal.notes || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}</p>
        <p><strong>ğŸ”¢ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ:</strong> ${animal.id}</p>
      `;

      if (animal.result && animal.status === "ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²") {
        html += `<p><strong>âœ… Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ:</strong> ${animal.result}</p>`;
        document.getElementById("pdfBtnContainer").classList.remove('hidden');
      } else {
        html += `<p class="text-orange-300">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ Ø¨Ø¹Ø¯.</p>`;
      }

      container.innerHTML = html;

      if (animal.image) {
        document.getElementById("animalImageContainer").innerHTML =
          `<img src="${animal.image}" class="w-40 h-40 rounded-full object-cover border-4 border-orange-400">`;
      }

      // ØªÙˆÙ„ÙŠØ¯ QR
      const qrUrl = `${location.origin}/animal-info.html?id=${animal.id}`;
      QRCode.toCanvas(document.getElementById("qrcode"), qrUrl, function (err) {
        if (err) console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ QR:", err);
      });
    }

    function showError(msg) {
      document.getElementById("animalDetails").innerHTML = `<p class="text-red-500">${msg}</p>`;
    }

    loadAnimal();
  </script>

  <!-- ØªÙˆÙ„ÙŠØ¯ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const card = document.querySelector('.max-w-2xl');
      const canvas = await html2canvas(card);
      const imgData = canvas.toDataURL('image/png');

      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "px",
        format: [canvas.width, canvas.height]
      });

      pdf.addImage(imgData, 'PNG', 0, 0);
      pdf.save("Ø¨Ø·Ø§Ù‚Ø©_Ø§Ù„Ø­ÙŠÙˆØ§Ù†.pdf");
    }
  </script>
</body>
</html>
